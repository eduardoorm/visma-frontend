<!-- Main Table -->
<div class="table-container">
  <nz-table
    #basicTable
    [nzData]="divisions"
    [nzLoading]="loading"
    [nzShowPagination]="false"
    [nzScroll]="{ x: '1200px' }"
    class="divisions-table">

    <!-- Table Header -->
    <thead>
      <tr class="table-header">
        <!-- Checkbox Column -->
        <th class="checkbox-col">
          <label nz-checkbox [(ngModel)]="allChecked" (ngModelChange)="onAllChecked($event)"></label>
        </th>

        <!-- División Column -->
        <th class="division-col" *ngIf="selectedColumns.includes('division')">
          <div class="header-cell">
            <span class="header-title">{{ getColumnLabel('division') }}</span>
            <div class="header-actions">
              <span nz-icon nzType="filter"
                    class="filter-icon"
                    [class.active]="filters.searchTerm || activeFilterColumn === 'name'"
                    nz-dropdown
                    [nzDropdownMenu]="divisionFilterMenu"
                    nzTrigger="click"
                    nzPlacement="bottomRight"
                    [nzVisible]="divisionFilterVisible"
                    (nzVisibleChange)="divisionFilterVisible = $event"
                    [attr.aria-label]="'Filtrar ' + getColumnLabel('division')"
                    (click)="onFilterIconClick($event, 'name')"></span>
              <div class="sort-icons">
                <span nz-icon nzType="caret-up"
                      class="sort-icon"
                      [class.active]="sorting.field === 'name' && sorting.direction === 'asc'"
                      [attr.aria-label]="'Ordenar ' + getColumnLabel('division') + ' ascendente'"
                      (click)="onSort('name', 'asc')"></span>
                <span nz-icon nzType="caret-down"
                      class="sort-icon"
                      [class.active]="sorting.field === 'name' && sorting.direction === 'desc'"
                      [attr.aria-label]="'Ordenar ' + getColumnLabel('division') + ' descendente'"
                      (click)="onSort('name', 'desc')"></span>
              </div>
            </div>
          </div>
          <nz-dropdown-menu #divisionFilterMenu="nzDropdownMenu">
            <div class="filter-dropdown-panel">
              <div class="filter-option-title">{{ filterLabels.division }}</div>
              <div class="filter-search-specific">
                <nz-input-group [nzSuffix]="nameSearchSuffix" class="name-search-input">
                  <input
                    type="text"
                    nz-input
                    [placeholder]="filterLabels.searchPlaceholder"
                    [(ngModel)]="nameSearchValue"
                    [attr.aria-label]="filterLabels.searchPlaceholder"
                    (keyup.enter)="onNameSearch()" />
                </nz-input-group>
                <ng-template #nameSearchSuffix>
                  <span nz-icon nzType="search" class="search-specific-icon" (click)="onNameSearch()" aria-label="Buscar"></span>
                </ng-template>
              </div>
              <div class="division-options" *ngIf="divisions.length">
       <div class="division-option"
         *ngFor="let division of divisions | filter: nameSearchValue"
         (click)="onDivisionFilter(division.name)"
         [class.selected]="filters.searchTerm === division.name">

                  {{ division.name }}
                </div>
              </div>
              <div class="filter-dropdown-actions">
                <button nz-button nzSize="small" nzType="default" (click)="clearNameFilter(); divisionFilterVisible = false">{{ filterLabels.resetButton }}</button>
                <button nz-button nzSize="small" nzType="primary" (click)="divisionFilterVisible = false">{{ filterLabels.applyButton }}</button>
              </div>
            </div>
          </nz-dropdown-menu>
        </th>

        <!-- División Superior Column -->
        <th class="parent-col" *ngIf="selectedColumns.includes('divisionSuperior')">
          <div class="header-cell">
            <span class="header-title">{{ getColumnLabel('divisionSuperior') }}</span>
            <div class="header-actions">
              <span nz-icon nzType="filter"
                    class="filter-icon"
                    [class.active]="filters.parentId || activeFilterColumn === 'parent'"
                    nz-dropdown
                    [nzDropdownMenu]="parentFilterMenu"
                    nzTrigger="click"
                    nzPlacement="bottomRight"
                    [nzVisible]="parentFilterVisible"
                    (nzVisibleChange)="parentFilterVisible = $event"
                    [attr.aria-label]="'Filtrar ' + getColumnLabel('divisionSuperior')"
                    (click)="onFilterIconClick($event, 'parent')"></span>
              <div class="sort-icons">
                <span nz-icon nzType="caret-up"
                      class="sort-icon"
                      [class.active]="sorting.field === 'parentId' && sorting.direction === 'asc'"
                      [attr.aria-label]="'Ordenar ' + getColumnLabel('divisionSuperior') + ' ascendente'"
                      (click)="onSort('parentId', 'asc')"></span>
                <span nz-icon nzType="caret-down"
                      class="sort-icon"
                      [class.active]="sorting.field === 'parentId' && sorting.direction === 'desc'"
                      [attr.aria-label]="'Ordenar ' + getColumnLabel('divisionSuperior') + ' descendente'"
                      (click)="onSort('parentId', 'desc')"></span>
              </div>
            </div>
          </div>
          <nz-dropdown-menu #parentFilterMenu="nzDropdownMenu">
            <div class="filter-dropdown-panel">
              <div class="filter-option-title">{{ filterLabels.divisionSuperior }}</div>
              <div class="filter-search-specific">
                <nz-input-group [nzSuffix]="parentSearchSuffix" class="name-search-input">
                  <input
                    type="text"
                    nz-input
                    [placeholder]="filterLabels.searchPlaceholder"
                    [(ngModel)]="parentSearchValue"
                    [attr.aria-label]="filterLabels.searchPlaceholder"
                  />
                </nz-input-group>
                <ng-template #parentSearchSuffix>
                  <span nz-icon nzType="search" class="search-specific-icon" aria-label="Buscar"></span>
                </ng-template>
              </div>
              <div class="division-parent-options" *ngIf="parentDivisions.length">
                <div class="parent-option"
                     *ngFor="let parent of parentDivisions | filter: parentSearchValue"
                     (click)="onParentFilter(parent.id)"
                     [class.selected]="filters.parentId === parent.id">
                  {{ parent.name }}
                </div>
                <div class="parent-option" (click)="onParentFilter(null)" [class.selected]="filters.parentId === undefined">
                  {{ filterLabels.noDivisionSuperior }}
                </div>
              </div>
              <div class="filter-dropdown-actions">
                <button nz-button nzSize="small" nzType="default" (click)="clearParentFilter(); parentFilterVisible = false">{{ filterLabels.resetButton }}</button>
                <button nz-button nzSize="small" nzType="primary" (click)="parentFilterVisible = false">{{ filterLabels.applyButton }}</button>
              </div>
            </div>
          </nz-dropdown-menu>
        </th>

        <!-- Colaboradores Column -->
        <th class="collaborators-col" *ngIf="selectedColumns.includes('colaboradores')">
          <div class="header-cell">
            <span class="header-title">{{ getColumnLabel('colaboradores') }}</span>
            <div class="header-actions">
              <div class="sort-icons">
                <span nz-icon nzType="caret-up"
                      class="sort-icon"
                      [class.active]="sorting.field === 'collaborators' && sorting.direction === 'asc'"
                      [attr.aria-label]="'Ordenar ' + getColumnLabel('colaboradores') + ' ascendente'"
                      (click)="onSort('collaborators', 'asc')"></span>
                <span nz-icon nzType="caret-down"
                      class="sort-icon"
                      [class.active]="sorting.field === 'collaborators' && sorting.direction === 'desc'"
                      [attr.aria-label]="'Ordenar ' + getColumnLabel('colaboradores') + ' descendente'"
                      (click)="onSort('collaborators', 'desc')"></span>
              </div>
            </div>
          </div>
        </th>

        <!-- Nivel Column -->
        <th class="level-col" *ngIf="selectedColumns.includes('nivel')">
          <div class="header-cell">
            <span class="header-title">{{ getColumnLabel('nivel') }}</span>
            <div class="header-actions">
              <div class="sort-icons">
                <span nz-icon nzType="caret-up"
                      class="sort-icon"
                      [class.active]="sorting.field === 'level' && sorting.direction === 'asc'"
                      [attr.aria-label]="'Ordenar ' + getColumnLabel('nivel') + ' ascendente'"
                      (click)="onSort('level', 'asc')"></span>
                <span nz-icon nzType="caret-down"
                      class="sort-icon"
                      [class.active]="sorting.field === 'level' && sorting.direction === 'desc'"
                      [attr.aria-label]="'Ordenar ' + getColumnLabel('nivel') + ' descendente'"
                      (click)="onSort('level', 'desc')"></span>
              </div>
              <span nz-icon nzType="filter"
                    class="filter-icon"
                    [class.active]="filters.level !== undefined || activeFilterColumn === 'level'"
                    nz-dropdown
                    [nzDropdownMenu]="levelFilterMenu"
                    nzTrigger="click"
                    nzPlacement="bottomRight"
                    [attr.aria-label]="'Filtrar ' + getColumnLabel('nivel')"
                    (click)="onFilterIconClick($event, 'level')"></span>
            </div>
          </div>
          <nz-dropdown-menu #levelFilterMenu="nzDropdownMenu">
            <div class="filter-dropdown-panel">
              <div class="filter-option-title">{{ filterLabels.nivel }}</div>
              <div class="level-options">
                <div class="level-option"
                    *ngFor="let level of levelOptions"
                    (click)="onLevelFilter(level.value)"
                    [class.selected]="filters.level === level.value">
                  {{ level.label }}
                </div>
              </div>
              <div class="filter-dropdown-actions">
                <button nz-button nzSize="small" nzType="default" (click)="onLevelFilter(null)">{{ filterLabels.resetButton }}</button>
                <button nz-button nzSize="small" nzType="primary">{{ filterLabels.applyButton }}</button>
              </div>
            </div>
          </nz-dropdown-menu>
        </th>

        <!-- Subdivisiones Column -->
        <th class="subdivisions-col" *ngIf="selectedColumns.includes('subdivisiones')">
          <div class="header-cell">
            <span class="header-title">{{ getColumnLabel('subdivisiones') }}</span>
            <div class="header-actions">
              <div class="sort-icons">
                <span nz-icon nzType="caret-up" class="sort-icon"></span>
                <span nz-icon nzType="caret-down" class="sort-icon"></span>
              </div>
            </div>
          </div>
        </th>

        <!-- Embajadores Column -->
        <th class="ambassadors-col" *ngIf="selectedColumns.includes('embajadores')">
          <div class="header-cell">
            <span class="header-title">{{ getColumnLabel('embajadores') }}</span>
          </div>
        </th>

        <!-- Acciones Column -->
        <th class="actions-col">
          <div class="header-cell">
            <span class="header-title">Acciones</span>
          </div>
        </th>
      </tr>
    </thead>

    <!-- Table Body -->
    <tbody>
      <tr *ngFor="let division of divisions; trackBy: trackByDivision" class="table-row">
        <!-- Checkbox -->
        <td class="checkbox-cell">
          <label nz-checkbox [(ngModel)]="checkedMap[division.id]" (ngModelChange)="onItemChecked(division.id, $event)"></label>
        </td>

        <!-- División Name -->
        <td class="division-cell" *ngIf="selectedColumns.includes('division')">
          <div class="division-content">
            <span class="division-name">{{ division.name }}</span>
          </div>
        </td>

        <!-- División Superior -->
        <td class="parent-cell" *ngIf="selectedColumns.includes('divisionSuperior')">
          {{ getParentDivisionName(division.parentId) }}
        </td>

        <!-- Colaboradores -->
        <td class="collaborators-cell" *ngIf="selectedColumns.includes('colaboradores')">
          {{ division.collaborators }}
        </td>

        <!-- Nivel -->
        <td class="level-cell" *ngIf="selectedColumns.includes('nivel')">
          {{ division.level }}
        </td>

        <!-- Subdivisiones -->
        <td class="subdivisions-cell" *ngIf="selectedColumns.includes('subdivisiones')">
          <div class="subdivisions-content">
            <span class="subdivisions-count">
              {{ getSubdivisionsCount(division) }}
            </span>
            <button
              nz-button
              nzType="default"
              nzSize="small"
              class="add-subdivision-btn"
              *ngIf="division.level < 5"
              [disabled]="getSubdivisionsCount(division) === 0"
              (click)="onViewSubdivisions(division, $event)">
              <span nz-icon nzType="plus"></span>
            </button>
          </div>
        </td>

        <!-- Embajadores -->
        <td class="ambassadors-cell" *ngIf="selectedColumns.includes('embajadores')">
          <span class="ambassador-name">{{ division.ambassadorName || '-' }}</span>
        </td>

        <!-- Acciones -->
        <td class="actions-cell">
          <div class="actions-content">
            <button
              nz-button
              nzType="text"
              nzSize="small"
              class="action-btn edit-btn"
              (click)="onEditDivision(division, $event)"
              title="Editar división">
              <span nz-icon nzType="edit"></span>
            </button>
            <button
              nz-button
              nzType="text"
              nzSize="small"
              nzDanger
              class="action-btn delete-btn"
              (click)="onDeleteDivision(division, $event)"
              title="Eliminar división">
              <span nz-icon nzType="delete"></span>
            </button>
          </div>
        </td>
      </tr>
    </tbody>
  </nz-table>
</div>

<!-- Modal para crear división -->
<app-create-division-modal
  [(visible)]="isModalVisible"
  [parentDivision]="selectedParentDivision"
  (divisionCreated)="onDivisionCreated()">
</app-create-division-modal>
